{% extends "base.html" %}
{% load static %}
{% block title %}{{ product.product_name }} ã®è©³ç´°{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm p-4">

        <div class="row">
            <!-- å·¦ï¼šå•†å“ç”»åƒ -->
            <div class="col-md-5 text-center">
                {% if product.url %}
                <img src="{{ product.url }}" alt="{{ product.product_name }}" class="img-fluid rounded">
                {% else %}
                <img src="{% static 'images/no_image.png' %}" alt="no_image" class="img-fluid rounded">
                {% endif %}
            </div>

            <!-- å³ï¼šå•†å“æƒ…å ± -->
            <div class="col-md-7">
                <h3 class="mb-3">{{ product.product_name }}</h3>
                <p class="text-muted mb-2">ã‚«ãƒ†ã‚´ãƒªï¼š{{ product.category.category_name }}</p>
                <p class="text-muted mb-2">ã‚·ãƒ§ãƒƒãƒ—åï¼š{{ product.shop_name|default:"ä¸æ˜" }}</p>
                <hr>

                <p class="mb-1"><strong>å®šä¾¡ï¼š</strong> Â¥{{ product.regular_price|floatformat:0 }}</p>
                <p class="mb-1"><strong>ç™»éŒ²æ™‚ä¾¡æ ¼ï¼š</strong> Â¥{{ product.initial_price|floatformat:0 }}</p>
                {% if product.threshold_price %}
                <p class="mb-1"><strong>è²·ã„æ™‚ä¾¡æ ¼ï¼š</strong> Â¥{{ product.threshold_price|floatformat:0 }}</p>
                {% endif %}
                <p class="mb-2">
                    <strong>å„ªå…ˆåº¦ï¼š</strong>
                    <span class="badge {% if product.priority == 'é«˜' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ product.priority }}
                    </span>
                </p>

                <a href="{{ product.product_url }}" class="btn btn-outline-primary mt-3" target="_blank">
                    å•†å“ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                </a>
            </div>
        </div>
    </div>

    <!-- ğŸ”¹ è²·ã„æ™‚ä¾¡æ ¼è¨­å®šã‚«ãƒ¼ãƒ‰ -->
    <div class="card shadow-sm p-4 mt-4">
        <h5 class="mb-3">è²·ã„æ™‚ä¾¡æ ¼ã®è¨­å®š</h5>

        {% if is_kaidoki %}
        <div id="kaidoki-banner" class="alert alert-success py-2 text-center fw-bold">
            è²·ã„æ™‚ï¼ ğŸ¯
        </div>

        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info text-center py-2 mt-2">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endif %}


        <script>
            // âœ… è²·ã„æ™‚ãƒãƒŠãƒ¼ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
            const banner = document.getElementById('kaidoki-banner');
            if (banner) {
                banner.style.opacity = 0;
                banner.style.transition = 'opacity 0.8s ease-out, transform 0.8s ease-out';
                banner.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    banner.style.opacity = 1;
                    banner.style.transform = 'scale(1)';
                }, 200);
            }

        </script>

        <form method="post" class="d-flex align-items-center justify-content-center gap-3">
            {% csrf_token %}
            {{ form.threshold_price }}
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </form>
    </div>

    <!-- âœ… Djangoã®json_scriptã§å®‰å…¨ã«åŸ‹ã‚è¾¼ã‚€ -->
    {{ price_data_json|json_script:"price-data-json" }}

    <!-- âœ… ä¾¡æ ¼æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆé‡è¤‡å‰Šé™¤æ¸ˆã¿ï¼‰ -->
    <div class="card shadow-sm p-4 mt-4">
        <h5 class="mb-3">ä¾¡æ ¼æ¨ç§»ã‚°ãƒ©ãƒ•</h5>
        <div class="chart-wrap" style="height: 320px; min-height: 320px;">
            <canvas id="priceChart"></canvas>
        </div>

    </div>


    <!-- â–¼ ã‚°ãƒ©ãƒ•æç”»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const canvas = document.getElementById("priceChart");
            const elem = document.getElementById("price-data-json");

            if (!canvas || !elem) {
                console.warn("â›” ã‚°ãƒ©ãƒ•ç”¨ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            // âœ… Canvasã‚µã‚¤ã‚ºã‚’å›ºå®š
            canvas.width = canvas.offsetWidth;
            canvas.height = 320;

            let priceData = [];
            try {
                const rawText = elem.textContent.replace(/\n/g, '').trim();
                priceData = JSON.parse(rawText);

                // âœ… ã‚‚ã—æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ã‚‚ã†ä¸€åº¦JSONåŒ–ï¼ˆ2é‡ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
                if (typeof priceData === "string") {
                    priceData = JSON.parse(priceData);
                }

                console.log("âœ… æœ€çµ‚ãƒ‘ãƒ¼ã‚¹å¾Œ priceData:", priceData);
            } catch (err) {
                console.error("âŒ JSONè§£æå¤±æ•—:", err);
                return;
            }

            // âœ… ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
            if (!Array.isArray(priceData) || priceData.length === 0) {
                console.warn("âš ï¸ priceDataãŒç©º:", priceData);
                canvas.insertAdjacentHTML("beforebegin", "<p class='text-center text-muted'>ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>");
                return;
            }

            // âœ… æ—¥ä»˜ï¼†ä¾¡æ ¼é…åˆ—ã‚’ä½œæˆ
            const labels = priceData.map(p => p.date);
            const prices = priceData.map(p => parseFloat(p.price));
            const threshold = parseFloat("{{ product.threshold_price|default:'0' }}") || 0;

            console.log("ğŸ“ˆ labels:", labels);
            console.log("ğŸ“Š prices:", prices);

            const datasets = [{
                label: "ä¾¡æ ¼ï¼ˆå††ï¼‰",
                data: prices,
                borderColor: "rgba(195, 86, 86, 1)",
                backgroundColor: "rgba(195, 86, 86, 0.15)",
                borderWidth: 2,
                fill: true,
                tension: 0.25,
                pointRadius: 3,
                pointHoverRadius: 5
            }];

            if (threshold > 0) {
                datasets.push({
                    label: "è²·ã„æ™‚ä¾¡æ ¼",
                    data: Array(labels.length).fill(threshold),
                    borderColor: "rgba(247, 203, 110, 1)",
                    borderDash: [5, 4],
                    pointRadius: 0,
                    fill: false
                });
            }

            // âœ… Chart.jsæç”»
            new Chart(canvas.getContext("2d"), {
                type: "line",
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "bottom"
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "æ—¥ä»˜"
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: "ä¾¡æ ¼ï¼ˆå††ï¼‰"
                            }
                        }
                    }
                }
            });
        });

    </script>

</div>
{% endblock %}
