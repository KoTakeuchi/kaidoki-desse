{% load static %}
{% load django_bootstrap5 %}

<!DOCTYPE html>
<html lang="ja">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>è²·ã„æ™‚ã§ã£ã›</title>
        <link rel="stylesheet" href="{% static 'css/app.css' %}">
        {% bootstrap_css %}
        {% bootstrap_javascript %}
    </head>

    <body class="bg-light">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header>
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
                <a class="navbar-brand d-flex align-items-center" href="{% url 'main:product_list' %}">
                    <img src="{% static 'images/icon_kaidoki.svg' %}" alt="è²·ã„æ™‚ã§ã£ã›ã‚¢ã‚¤ã‚³ãƒ³" width="30" class="me-2">
                    <strong>è²·ã„æ™‚ã§ã£ã›</strong>
                </a>

                <!-- ğŸ”¹ ãƒŠãƒ“å³å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                <ul class="navbar-nav ms-auto align-items-center">

                    {% if user.is_authenticated %}
                    <li class="nav-item me-3">
                        <span class="text-muted small">{{ user.username }} ã•ã‚“</span>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'main:product_list' %}">å•†å“ä¸€è¦§</a>
                    </li>

                    <!-- âœ… é€šçŸ¥ãƒœã‚¿ãƒ³ï¼ˆæœªèª­ãƒãƒƒã‚¸ä»˜ãï¼‰ -->
                    <li class="nav-item position-relative">
                        <a class="nav-link position-relative" href="{% url 'notifications' %}">
                            é€šçŸ¥
                            <span id="unread-count"
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                style="font-size: 0.7rem; display: none;">
                            </span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="{% url 'main:product_create' %}" class="btn btn-outline-primary ms-2">ï¼‹ å•†å“ç™»éŒ²</a>
                    </li>

                    <li class="nav-item">
                        <a href="{% url 'logout' %}" class="btn btn-outline-danger ms-2">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a href="{% url 'login' %}" class="btn btn-outline-primary">ãƒ­ã‚°ã‚¤ãƒ³</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ -->
        <main class="container py-4">
            {% block content %}
            {% endblock %}
        </main>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="text-center text-muted py-3">
            <small>Â© 2025 è²·ã„æ™‚ã§ã£ã›ã€€
                <a href="#" class="text-decoration-none">åˆ©ç”¨è¦ç´„</a>ã€€
                <a href="#" class="text-decoration-none">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</a>
            </small>
        </footer>

        <!-- âœ… Ajaxã§æœªèª­é€šçŸ¥ãƒãƒƒã‚¸ã‚’æ›´æ–° -->
        <script>
            async function updateUnreadCount() {
                try {
                    const response = await fetch("{% url 'unread_count_api' %}");
                    if (!response.ok) throw new Error("Network response was not ok");
                    const data = await response.json();

                    const badge = document.getElementById("unread-count");
                    if (badge) {
                        if (data.unread_count > 0) {
                            badge.textContent = data.unread_count;
                            badge.style.display = "inline-block";
                        } else {
                            badge.style.display = "none";
                        }
                    }
                } catch (error) {
                    console.error("Error fetching unread count:", error);
                }
            }

            // ğŸ”¹ ãƒšãƒ¼ã‚¸èª­è¾¼æ™‚ã«å³å®Ÿè¡Œã€ä»¥å¾Œ60ç§’ã”ã¨ã«æ›´æ–°
            document.addEventListener("DOMContentLoaded", updateUnreadCount);
            setInterval(updateUnreadCount, 60000);

        </script>

    </body>

</html>
