{% extends "base.html" %}
{% load static %}
{% load form_tags %}
{% load django_bootstrap5 %}

{% block content %}
<style>
.card {
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  border: 1px solid #eee;
}
.form-control {
  border-radius: 8px;
  border: 1px solid #ddd;
  transition: all 0.2s ease-in-out;
}
.form-control:focus {
  border-color: #C35656;
  box-shadow: 0 0 0 0.2rem rgba(195, 86, 86, 0.15);
}
.form-control[disabled],
.form-select[disabled] {
  background-color: #f7f7f7 !important;
  color: #777 !important;
  cursor: not-allowed !important;
  border-color: #ddd !important;
  opacity: 1 !important;
}
.url-help {
  font-size: 0.9rem;
  color: #777;
  margin-top: 4px;
}
.flag-group {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 8px;
}
.flag-option {
  flex: 1;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}
.flag-option:hover {
  background-color: #fff5f5;
  border-color: #C35656;
}
input[type="radio"]:checked + .flag-option {
  background-color: #C35656;
  color: white;
  border-color: #C35656;
}
.price-group {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}
.price-card {
  flex: 1;
  min-width: 200px;
}
.price-card label {
  font-weight: 600;
  color: #555;
}
.btn-submit {
  background-color: #C35656;
  border: none;
  color: white;
  font-weight: 600;
  padding: 10px 30px;
  border-radius: 10px;
  transition: 0.2s;
}
.btn-submit:hover {
  background-color: #a83f3f;
}
.text-danger.small { margin-top: 4px; }

/* âœ… APIé€šä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
#api-status-message {
  font-weight: 600;
  padding: 8px;
  border-radius: 8px;
  display: none;
}
#api-status-message.success {
  color: #155724;
  background-color: #d4edda;
  border: 1px solid #c3e6cb;
}
#api-status-message.error {
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
}

/* âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ */
#preview-image {
  width: 400px;
  height: 400px;
  object-fit: contain;
  background-color: #fff;
  border: 2px solid #eee;
  border-radius: 10px;
}
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{% if is_edit %}å•†å“ç·¨é›†{% else %}æ–°è¦å•†å“ç™»éŒ²{% endif %}</h2>
        <a href="{% url 'main:product_list' %}" class="btn btn-secondary">ä¸€è¦§ã¸æˆ»ã‚‹</a>
    </div>

    <form method="POST" novalidate>
        {% csrf_token %}
        <div class="card shadow-sm p-4">

            <!-- âœ… å•†å“URL -->
            {% if not is_edit %}
            <div class="mb-4">
                <label class="form-label fw-bold">å•†å“URL</label>
                {{ form.product_url }}
                <div class="url-help">
                    æ¥½å¤©å¸‚å ´ <strong>https://item.rakuten.co.jp/</strong> ã®å•†å“URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </div>
                <div id="url-error" class="text-danger small mt-1"></div>
            </div>
            {% endif %}

            <!-- âœ… APIé€šä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div id="api-status-message" class="mt-2 small text-center"></div>

            <!-- âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ -->
            <div class="text-center mt-3">
                <img id="preview-image" src="{% static 'images/noimage.png' %}" alt="å•†å“ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
            </div>

            <!-- å•†å“åãƒ»ã‚·ãƒ§ãƒƒãƒ—å -->
            <div class="row mb-3 mt-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold">å•†å“å</label>
                    {{ form.product_name }}
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">ã‚·ãƒ§ãƒƒãƒ—å</label>
                    {{ form.shop_name }}
                </div>
            </div>

            <!-- ä¾¡æ ¼ç¾¤ -->
            <div class="price-group mb-4">
                <div class="price-card">
                    <label>å®šä¾¡</label>
                    {{ form.regular_price }}
                </div>
                <div class="price-card">
                    <label>ç™»éŒ²æ™‚ä¾¡æ ¼</label>
                    {{ form.initial_price }}
                </div>
                <div class="price-card">
                    <label>è²·ã„æ™‚ä¾¡æ ¼</label>
                    {{ form.threshold_price }}
                </div>
            </div>

            <!-- å„ªå…ˆåº¦ -->
            <div class="mb-4">
                <label class="form-label fw-bold">å„ªå…ˆåº¦</label><br>
                {{ form.priority }}
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-submit">
                    {% if is_edit %}æ›´æ–°ã™ã‚‹{% else %}ç™»éŒ²ã™ã‚‹{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

{% if not is_edit %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const urlInput = document.querySelector("input[name='product_url']");
  const previewImage = document.querySelector("#preview-image");
  const apiStatus = document.querySelector("#api-status-message");
  const errorArea = document.querySelector("#url-error");

  console.log("âœ… JS Loaded: fetch_rakuten_item ready");

  if (!urlInput) {
    console.error("âŒ URLå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  const triggerFetch = async () => {
    const url = urlInput.value.trim();
    if (!url) return;

    console.log("ğŸ“¡ Fetch start:", url);

    apiStatus.style.display = "none";
    errorArea.textContent = "";

    try {
      const response = await fetch(`/main/api/fetch_rakuten_item/?url=${encodeURIComponent(url)}`);
      const data = await response.json();

      console.log("âœ… RakutenAPI Response:", data);

      if (!response.ok || data.error) throw new Error(data.error || `HTTP ${response.status}`);

      // --- å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆï¼ˆnameå±æ€§ãƒ™ãƒ¼ã‚¹ã§å®‰å…¨ï¼‰ ---
      const setValue = (name, value) => {
        const field = document.querySelector(`[name='${name}']`);
        if (field) field.value = value || "";
      };

      setValue("product_name", data.product_name);
      setValue("shop_name", data.shop_name);
      setValue("regular_price", data.regular_price);
      setValue("initial_price", data.initial_price);

      // --- ç”»åƒæ›´æ–° ---
      previewImage.src = data.image_url || "{% static 'images/noimage.png' %}";

      // --- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ---
      apiStatus.textContent = "âœ… æ¥½å¤©APIé€šä¿¡æˆåŠŸï¼ˆå•†å“æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸï¼‰";
      apiStatus.className = "mt-2 small text-center success";
      apiStatus.style.display = "block";

    } catch (err) {
      console.error("âŒ Fetch Error:", err);
      previewImage.src = "{% static 'images/noimage.png' %}";
      apiStatus.textContent = "âš ï¸ æ¥½å¤©APIé€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      apiStatus.className = "mt-2 small text-center error";
      apiStatus.style.display = "block";
    }
  };

  // âœ… URLå…¥åŠ›ã®ç¢ºå®šæ™‚ã‚¤ãƒ™ãƒ³ãƒˆ
  urlInput.addEventListener("change", triggerFetch);
  urlInput.addEventListener("blur", triggerFetch);
  urlInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      triggerFetch();
    }
  });
});
</script>

{% endif %}
{% endblock %}
