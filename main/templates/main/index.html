<!-- å®Ÿè¡Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: I:\school\kaidoki-desse\main\templates\main\index.html -->
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4 fw-bold">å•†å“ä¸€è¦§</h2>

    <!-- ğŸ”¹ ä¸Šéƒ¨ãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="d-flex justify-content-end align-items-center mb-3">
        <a href="{% url 'main:product_create' %}" class="btn btn-success me-2">ï¼‹ å•†å“ç™»éŒ²</a>
        <a href="{% url 'main:categories' %}" class="btn btn-outline-primary me-2">ã‚«ãƒ†ã‚´ãƒªç·¨é›†</a>
        {% if user.is_staff %}
        <a href="{% url 'main:admin_categories' %}" class="btn btn-outline-danger">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</a>
        {% endif %}
    </div>

    <!-- =============================
         ğŸ” çµã‚Šè¾¼ã¿ãƒ–ãƒ­ãƒƒã‚¯
    ============================== -->
    <div class="border rounded shadow-sm p-3 mb-3" style="background-color:#f1f3f5;">
        <form method="get" class="p-3 border rounded" style="background-color:#ffffff;">
            <input type="hidden" name="current_sort" value="{{ sort }}">

            <!-- ğŸ”¹ æ¤œç´¢ -->
            <div class="mb-2">
                <input type="text" name="q" value="{{ query|default_if_none:'' }}" class="form-control" placeholder="å•†å“åãƒ»ã‚·ãƒ§ãƒƒãƒ—åã§æ¤œç´¢">
            </div>

            <!-- ğŸ”¹ ã‚«ãƒ†ã‚´ãƒªï¼ˆå…±é€šãƒ»ç‹¬è‡ªï¼‰ -->
            <div class="mb-2">
                <span class="fw-semibold me-1">ã‚«ãƒ†ã‚´ãƒª(å…±é€š)</span><br>
                {% for cat in common_categories %}
                <div class="form-check form-check-inline me-1 mb-1">
                    <input class="form-check-input" type="checkbox" name="category" id="cat_common{{ cat.id }}" value="{{ cat.id }}" {% if cat.id|stringformat:"s" in selected_categories %}checked{% endif %}>
                    <label class="form-check-label" for="cat_common{{ cat.id }}">{{ cat.category_name }}</label>
                </div>
                {% endfor %}
            </div>

            <div class="mb-2">
                <span class="fw-semibold me-1">ã‚«ãƒ†ã‚´ãƒª(ç‹¬è‡ª)</span><br>
                {% for cat in custom_categories %}
                <div class="form-check form-check-inline me-1 mb-1">
                    <input class="form-check-input" type="checkbox" name="category" id="cat_custom{{ cat.id }}" value="{{ cat.id }}" {% if cat.id|stringformat:"s" in selected_categories %}checked{% endif %}>
                    <label class="form-check-label" for="cat_custom{{ cat.id }}">{{ cat.category_name }}</label>
                </div>
                {% endfor %}
            </div>

            <!-- ğŸ”¹ åœ¨åº«ï¼‹å„ªå…ˆåº¦ -->
            <div class="d-flex align-items-center justify-content-between flex-wrap mt-2">
                <div>
                    <span class="fw-semibold me-1">åœ¨åº«</span>
                    {% for val, label in stock_choices %}
                    <div class="form-check form-check-inline me-1">
                        <input class="form-check-input" type="radio" name="stock" id="stock_{{ val }}" value="{{ val }}" {% if stock_filter == val %}checked{% endif %}>
                        <label class="form-check-label" for="stock_{{ val }}">{{ label }}</label>
                    </div>
                    {% endfor %}
                </div>

                <div class="ms-3">
                    <span class="fw-semibold me-1">å„ªå…ˆåº¦</span>
                    {% for val, label in priority_choices %}
                    <div class="form-check form-check-inline me-1">
                        <input class="form-check-input" type="radio" name="priority" id="pri_{{ val }}" value="{{ val }}" {% if priority_filter == val %}checked{% endif %}>
                        <label class="form-check-label" for="pri_{{ val }}">{{ label }}</label>
                    </div>
                    {% endfor %}
                </div>

                <!-- ğŸ”¹ ãƒœã‚¿ãƒ³ -->
                <div class="ms-auto">
                    {% if is_filtered %}
                    <a href="{% url 'main:product_list' %}?sort={{ sort }}" class="btn btn-outline-secondary me-2">ã‚¯ãƒªã‚¢</a>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">çµã‚Šè¾¼ã¿</button>
                </div>
            </div>
        </form>

        <!-- ğŸ·ï¸ çµã‚Šè¾¼ã¿ã‚¿ã‚° -->
        <div class="mt-2">
            {% if query %}<span class="badge bg-primary me-1">{{ query }}</span>{% endif %}
            {% if stock_filter == "in" %}<span class="badge bg-success me-1">åœ¨åº«ã‚ã‚Š</span>{% endif %}
            {% if stock_filter == "low" %}<span class="badge bg-warning text-dark me-1">åœ¨åº«ã‚ãšã‹</span>{% endif %}
            {% if stock_filter == "out" %}<span class="badge bg-dark me-1">åœ¨åº«ãªã—</span>{% endif %}
            {% if priority_filter != "all" %}<span class="badge bg-danger me-1">å„ªå…ˆåº¦ï¼š{{ priority_filter }}</span>{% endif %}
        </div>
    </div>

    <!-- =============================
         âš™ï¸ ã‚½ãƒ¼ãƒˆãƒ»ç™»éŒ²ãƒ»å‰Šé™¤ è¡Œ
    ============================== -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <select name="sort" class="form-select w-auto d-inline" onchange="location.href='?sort='+this.value;">
                <option value="new" {% if sort == "new" %}selected{% endif %}>æ–°ã—ã„é †</option>
                <option value="old" {% if sort == "old" %}selected{% endif %}>å¤ã„é †</option>
                <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>å®‰ã„é †</option>
                <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>é«˜ã„é †</option>
            </select>
        </div>
        <div>
            <button type="button" id="bulk-delete-btn" class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" style="display:none;">
                ä¸€æ‹¬å‰Šé™¤
            </button>
            <a href="{% url 'main:product_create' %}" class="btn btn-success">ï¼‹ å•†å“ç™»éŒ²</a>
        </div>
    </div>

    <!-- =============================
         ğŸ“¦ å•†å“ã‚«ãƒ¼ãƒ‰ä¸€è¦§
    ============================== -->
    <div class="row g-3" id="product-list">
        {% for product in products %}
        <div class="col-lg-3 col-md-4 col-sm-6">
            <div class="card product-card position-relative h-100 shadow-sm
                {% if product.is_kaidoki and product.is_low_stock %}
                    border-3" style="border-color:#000000;" {% elif product.is_kaidoki %} border-danger border-3 {% elif product.is_low_stock %} border-warning border-3 {% else %} border-light {% endif %}" data-href="{% url 'main:product_detail' product.id %}">
                <input type="checkbox" name="selected_products" value="{{ product.id }}" class="form-check-input position-absolute top-0 start-0 m-2 card-select">
                <img src="{% static 'images/no_image.png' %}" class="card-img-top" alt="No image">

                <div class="position-absolute top-0 end-0 d-flex flex-column align-items-end m-2">
                    {% if product.is_kaidoki %}
                    <span class="badge mb-1" style="background-color:#F8D7DA; color:#7A1E1E;">è²·ã„æ™‚</span>
                    {% endif %}
                    {% if product.is_low_stock %}
                    <span class="badge" style="background-color:#FFF3CD; color:#8A6D3B;">åœ¨åº«ã‚ãšã‹</span>
                    {% endif %}
                </div>

                <div class="card-body text-center">
                    <h5 class="card-title text-truncate">{{ product.product_name }}</h5>
                    <p class="mb-1 text-muted small">ã‚«ãƒ†ã‚´ãƒª {{ product.category.category_name|default:"æœªåˆ†é¡" }}</p>
                    <p class="mb-1">æœ€æ–°ä¾¡æ ¼ Â¥{{ product.latest_price|default:"-" }}</p>
                    <p class="mb-2">å„ªå…ˆåº¦
                        {% if product.priority == "é«˜" %}
                        <span class="badge bg-danger">é«˜</span>
                        {% else %}
                        <span class="badge bg-secondary">æ™®é€š</span>
                        {% endif %}
                    </p>
                    <a href="{% url 'main:product_edit' product.id %}" class="btn btn-danger w-75">ç·¨é›†</a>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-muted">å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        {% endfor %}
    </div>

    <!-- =============================
         ğŸ—‘ ä¸€æ‹¬å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«
    ============================== -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‰Šé™¤ç¢ºèª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
                </div>
                <div class="modal-body">é¸æŠã—ãŸå•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <form method="post" id="bulk-delete-form">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">å‰Šé™¤ã™ã‚‹</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/main.js' %}"></script>
{% endblock %}
