{% extends "base.html" %}
{% load static %}
{% block title %}{{ product.product_name }} ã®è©³ç´°{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <div class="row">
            <!-- å·¦ï¼šå•†å“ç”»åƒ -->
            <div class="col-md-5 text-center">
                {% if product.image_url %}
                <img src="{{ product.image_url }}" alt="{{ product.product_name }}"
                    class="img-fluid rounded {% if not product.is_in_stock %}opacity-50{% endif %}">
                {% else %}
                <img src="{% static 'images/no_image.png' %}" alt="no_image"
                    class="img-fluid rounded {% if not product.is_in_stock %}opacity-50{% endif %}">
                {% endif %}

                <!-- âœ… åœ¨åº«ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                {% if not product.is_in_stock %}
                <div class="alert alert-secondary small mt-3" role="alert">
                    ç¾åœ¨ã“ã®å•†å“ã¯åœ¨åº«åˆ‡ã‚Œã§ã™ã€‚å†å…¥è·æ™‚ã«é€šçŸ¥ã‚’å—ã‘å–ã‚ŠãŸã„å ´åˆã¯ã€Œåœ¨åº«å¾©æ´»é€šçŸ¥ã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
                </div>
                {% endif %}
            </div>

            <!-- å³ï¼šå•†å“æƒ…å ± -->
            <div class="col-md-7">
                <h3 class="mb-3">
                    {{ product.product_name }}
                    {% if not product.is_in_stock %}
                    <span class="badge bg-secondary ms-2">åœ¨åº«ãªã—</span>
                    {% else %}
                    <span class="badge bg-success ms-2">åœ¨åº«ã‚ã‚Š</span>
                    {% endif %}
                </h3>

                <p class="text-muted mb-2">ã‚«ãƒ†ã‚´ãƒªï¼š{{ product.category.category_name }}</p>
                <p class="text-muted mb-2">ã‚·ãƒ§ãƒƒãƒ—åï¼š{{ product.shop_name|default:"ä¸æ˜" }}</p>
                <hr>

                <p class="mb-1"><strong>å®šä¾¡ï¼š</strong>
                    {% if product.regular_price %}
                    Â¥{{ product.regular_price|floatformat:0 }}
                    {% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
                </p>

                <p class="mb-1"><strong>ç™»éŒ²æ™‚ä¾¡æ ¼ï¼š</strong>
                    {% if product.initial_price %}
                    Â¥{{ product.initial_price|floatformat:0 }}
                    {% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
                </p>

                <p class="mb-1"><strong>è²·ã„æ™‚ä¾¡æ ¼ï¼š</strong>
                    {% if product.threshold_price %}
                    Â¥{{ product.threshold_price|floatformat:0 }}
                    {% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
                </p>

                <p class="mb-2">
                    <strong>å„ªå…ˆåº¦ï¼š</strong>
                    <span class="badge {% if product.priority == 'é«˜' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ product.priority }}
                    </span>
                </p>

                <a href="{{ product.product_url }}"
                    class="btn btn-outline-primary mt-3 {% if not product.is_in_stock %}disabled{% endif %}"
                    target="_blank">
                    å•†å“ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                </a>
            </div>
        </div>
    </div>

    <!-- ğŸ”¹ è²·ã„æ™‚ä¾¡æ ¼è¨­å®šã‚«ãƒ¼ãƒ‰ -->
    <div class="card shadow-sm p-4 mt-4">
        <h5 class="mb-3">è²·ã„æ™‚ä¾¡æ ¼ã®è¨­å®š</h5>

        {% if is_kaidoki %}
        <div id="kaidoki-banner" class="alert alert-success py-2 text-center fw-bold">
            è²·ã„æ™‚ï¼ ğŸ¯
        </div>

        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info text-center py-2 mt-2">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endif %}

        <script>
            const banner = document.getElementById('kaidoki-banner');
            if (banner) {
                banner.style.opacity = 0;
                banner.style.transition = 'opacity 0.8s ease-out, transform 0.8s ease-out';
                banner.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    banner.style.opacity = 1;
                    banner.style.transform = 'scale(1)';
                }, 200);
            }
        </script>

        <form method="post" class="d-flex align-items-center justify-content-center gap-3">
            {% csrf_token %}
            {{ form.threshold_price }}
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </form>

        {% if form.threshold_price.errors %}
        <div class="text-danger small text-center mt-2">
            {{ form.threshold_price.errors.0 }}
        </div>
        {% endif %}
    </div>

    {{ price_data_json|json_script:"price-data-json" }}

    <!-- ğŸ”¹ ä¾¡æ ¼ Ã— åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ• -->
    <div class="card shadow-sm p-4 mt-4">
        <h5 class="mb-3">ä¾¡æ ¼ Ã— åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ•</h5>
        <div class="chart-wrap" style="height: 340px; min-height: 340px;">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const canvas = document.getElementById("priceChart");
            const elem = document.getElementById("price-data-json");
            if (!canvas || !elem) return;

            let priceData = [];
            try {
                const rawText = elem.textContent.replace(/\n/g, '').trim();
                priceData = JSON.parse(rawText);
                if (typeof priceData === "string") priceData = JSON.parse(priceData);
            } catch {
                console.error("ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
                return;
            }

            if (!Array.isArray(priceData) || priceData.length === 0) {
                canvas.insertAdjacentHTML("beforebegin",
                    "<p class='text-center text-muted'>ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>");
                return;
            }

            // ğŸ”¹ ãƒ‡ãƒ¼ã‚¿æ•´å½¢ï¼ˆNaNãƒ»nullå¯¾ç­–è¾¼ã¿ï¼‰
            const labels = priceData.map(p => p.date);
            const prices = priceData.map(p => parseFloat(p.price));
            const stocks = priceData.map(p => {
                const val = parseFloat(p.stock);
                return isNaN(val) ? 0 : val;
            });
            const threshold = parseFloat("{{ product.threshold_price|default:'0' }}") || 0;

            // ğŸ”¹ åœ¨åº«è»¸ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è‡ªå‹•è£œæ­£
            const maxStock = Math.max(...stocks);
            const suggestedMaxStock = maxStock > 0 ? maxStock + 1 : 1;

            new Chart(canvas.getContext("2d"), {
                data: {
                    labels,
                    datasets: [
                        // ğŸ”¸ä¾¡æ ¼ï¼ˆæŠ˜ã‚Œç·šï¼‰
                        {
                            label: "ä¾¡æ ¼ï¼ˆå††ï¼‰",
                            data: prices,
                            yAxisID: "yPrice",
                            type: "line",
                            borderColor: "#C35656",           // ãƒ–ãƒ©ãƒ³ãƒ‰èµ¤
                            backgroundColor: "transparent",    // å¡—ã‚Šãªã—
                            borderWidth: 2.5,
                            fill: false,
                            tension: 0.25,
                            pointRadius: 4,
                            pointBackgroundColor: prices.map(v =>
                                v < threshold && threshold > 0 ? "#FF4B4B" : "#C35656"
                            ),
                            order: 1
                        },
                        // ğŸ”¹åœ¨åº«ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
                        {
                            label: "åœ¨åº«æ•°ï¼ˆå€‹ï¼‰",
                            data: stocks,
                            yAxisID: "yStock",
                            type: "bar",
                            backgroundColor: "rgba(106, 144, 181, 0.6)", // é’ã¿ã‚°ãƒ¬ãƒ¼ï¼ˆ#6A90B5ï¼‰
                            borderColor: "#6A90B5",
                            borderWidth: 1,
                            order: 2
                        },
                        // ğŸŸ¡è²·ã„æ™‚ãƒ©ã‚¤ãƒ³ï¼ˆã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰
                        ...(threshold > 0 ? [{
                            label: "è²·ã„æ™‚ä¾¡æ ¼",
                            data: Array(labels.length).fill(threshold),
                            yAxisID: "yPrice",
                            borderColor: "#F7CB6E",   // ãƒ–ãƒ©ãƒ³ãƒ‰é»„è‰²
                            borderDash: [5, 4],
                            borderWidth: 5,           // â† 2 â†’ 5 ã«å¤ªãå¤‰æ›´
                            type: "line",
                            fill: false,
                            pointRadius: 0,
                            order: 10,                // â† æœ€å‰é¢ã§æç”»ã•ã‚Œã‚‹ã‚ˆã†èª¿æ•´
                            segment: {
                                borderDashOffset: 0,  // ãƒ€ãƒƒã‚·ãƒ¥ç·šã‚’æ˜ç­ã«
                            },
                        }] : []),

                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: "æ—¥ä»˜" }
                        },
                        yPrice: {
                            type: "linear",
                            position: "left",
                            title: { display: true, text: "ä¾¡æ ¼ï¼ˆå††ï¼‰" },
                            grid: { drawOnChartArea: true },
                        },
                        yStock: {
                            type: "linear",
                            position: "right",
                            title: { display: true, text: "åœ¨åº«æ•°ï¼ˆå€‹ï¼‰" },
                            grid: { drawOnChartArea: false },
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                stepSize: 1,
                                callback: value => Number.isInteger(value) ? value : ''
                            },
                            suggestedMax: suggestedMaxStock
                        }
                    },
                    plugins: {
                        legend: { position: "bottom" }
                    }
                }
            });

        });
    </script>

</div>
{% endblock %}
