{% extends "layout-user.html" %}
{% load static %}
{% block title %}{{ product.product_name }} ã®è©³ç´°{% endblock %}

{% block page_content %}
<!-- âœ… AUTHæº–æ‹ ã‚¿ã‚¤ãƒˆãƒ«æ§‹é€  -->
<div class="page-header">
  <h1 class="page-title">
    <span class="title-inner">å•†å“è©³ç´°</span>
  </h1>
</div>

<div class="container py-4">
  <!-- å•†å“æƒ…å ± -->
  <div class="card shadow-sm p-4 mb-4">
    <div class="row g-4">
      <!-- ğŸ–¼ å·¦ï¼šå•†å“ç”»åƒ -->
      <div class="col-md-5 text-center">
        <img
          src="{% if product.image_url %}{{ product.image_url }}{% else %}{% static 'images/no_image.png' %}{% endif %}"
          alt="{{ product.product_name }}"
          class="img-fluid rounded {% if not product.is_in_stock %}opacity-50{% endif %}"
        >

        {% if not product.is_in_stock %}
        <div class="alert alert-secondary small mt-3 text-center">
          ç¾åœ¨ã“ã®å•†å“ã¯åœ¨åº«åˆ‡ã‚Œã§ã™ã€‚<br>
          å†å…¥è·æ™‚ã«é€šçŸ¥ã‚’å—ã‘å–ã‚ŠãŸã„å ´åˆã¯ä»¥ä¸‹ã§è¨­å®šã§ãã¾ã™ã€‚
        </div>
        <form method="post" class="text-center mt-2">
          {% csrf_token %}
          <button type="submit" name="toggle_restock_notify"
            class="btn {% if product.restock_notify_enabled %}btn-outline-danger{% else %}btn-outline-success{% endif %} btn-sm rounded-pill px-4">
            {% if product.restock_notify_enabled %}é€šçŸ¥ã‚’åœæ­¢{% else %}é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–{% endif %}
          </button>
        </form>
        {% endif %}
      </div>

      <!-- ğŸ“‹ å³ï¼šå•†å“æƒ…å ± -->
      <div class="col-md-7">
        <h3 class="fw-bold mb-3">
          {{ product.product_name }}
          {% if product.is_in_stock %}
          <span class="badge bg-success ms-2">åœ¨åº«ã‚ã‚Š</span>
          {% else %}
          <span class="badge bg-secondary ms-2">åœ¨åº«ãªã—</span>
          {% endif %}
        </h3>

        <p class="mb-2">
          <strong>ã‚·ãƒ§ãƒƒãƒ—åï¼š</strong>{{ product.shop_name|default:"ä¸æ˜" }}
        </p>

        <p class="mb-2">
          <strong>ã‚«ãƒ†ã‚´ãƒªï¼š</strong>
          {% if product.common_category %}
            <span class="badge bg-warning text-dark me-1">[å…±é€š] {{ product.common_category.category_name }}</span>
          {% endif %}
          {% for cat in product.categories.all %}
            <span class="badge bg-secondary me-1">{{ cat.category_name }}</span>
          {% empty %}
            <span class="text-muted">æœªåˆ†é¡</span>
          {% endfor %}
        </p>

        <p class="mb-1"><strong>å®šä¾¡ï¼š</strong>
          {% if product.regular_price %}Â¥{{ product.regular_price|floatformat:0 }}{% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
        </p>
        <p class="mb-1"><strong>ç™»éŒ²æ™‚ä¾¡æ ¼ï¼š</strong>
          {% if product.initial_price %}Â¥{{ product.initial_price|floatformat:0 }}{% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
        </p>
        <p class="mb-1"><strong>è²·ã„æ™‚ä¾¡æ ¼ï¼š</strong>
          {% if product.threshold_price %}Â¥{{ product.threshold_price|floatformat:0 }}{% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
        </p>

        <p class="mt-2">
          <strong>å„ªå…ˆåº¦ï¼š</strong>
          <span class="badge {% if product.priority == 'é«˜' %}bg-danger{% else %}bg-secondary{% endif %}">
            {{ product.priority }}
          </span>
        </p>

        <a href="{{ product.product_url }}" target="_blank"
          class="btn btn-outline-primary mt-3 {% if not product.is_in_stock %}disabled{% endif %}">
          å•†å“ãƒšãƒ¼ã‚¸ã‚’é–‹ã
        </a>
      </div>
    </div>
  </div>

  <!-- ğŸ’° è²·ã„æ™‚ä¾¡æ ¼è¨­å®š -->
  <div class="card shadow-sm p-4 mb-4">
    <h5 class="mb-3">è²·ã„æ™‚ä¾¡æ ¼ã®è¨­å®š</h5>

    {% if messages %}
      {% for message in messages %}
      <div class="alert alert-info text-center py-2">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" class="d-flex align-items-center justify-content-center gap-3">
      {% csrf_token %}
      <input type="hidden" name="save_threshold" value="1">
      {{ form.threshold_price }}
      <button type="submit" class="btn btn-danger rounded-pill px-4">æ›´æ–°</button>
    </form>

    {% if form.threshold_price.errors %}
    <div class="text-danger small text-center mt-2">
      {{ form.threshold_price.errors.0 }}
    </div>
    {% endif %}
  </div>

  <!-- ğŸ“ˆ ä¾¡æ ¼å±¥æ­´ã‚°ãƒ©ãƒ• -->
  <div class="card shadow-sm p-4 mb-4">
    <h5 class="mb-3">ä¾¡æ ¼ Ã— åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ•</h5>

    {% if has_history %}
    {{ price_data_json|json_script:"price-data-json" }}
    <div class="chart-wrap">
      <canvas id="priceChart" data-threshold="{{ product.threshold_price|default:0 }}"></canvas>
    </div>
    {% else %}
    <p class="text-center text-muted mb-0 py-4">ä¾¡æ ¼å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
  </div>

  <!-- ğŸ”™ æˆ»ã‚‹ï¼å‰Šé™¤ -->
  <div class="d-flex justify-content-between mt-4">
    <a href="{% url 'main:product_list' %}" class="btn btn-outline-secondary rounded-pill px-4">
      â† ä¸€è¦§ã¸æˆ»ã‚‹
    </a>
    <form method="post" action="{% url 'main:product_delete' pk=product.id %}"
          onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-danger rounded-pill px-4">
        å‰Šé™¤ã™ã‚‹
      </button>
    </form>
  </div>
</div>

<!-- âœ… å¤–éƒ¨JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="{% static 'js/product_detail.js' %}"></script>
{% endblock %}
