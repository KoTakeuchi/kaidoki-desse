{% extends "layout-user.html" %}
{% load static %}
{% block title %}{{ product.product_name }} ã®è©³ç´°{% endblock %}

{% block page_content %}
<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <div class="row">
            <!-- å·¦ï¼šå•†å“ç”»åƒ -->
            <div class="col-md-5 text-center">
                {% if product.image_url %}
                <img src="{{ product.image_url }}" alt="{{ product.product_name }}"
                    class="img-fluid rounded {% if not product.is_in_stock %}opacity-50{% endif %}">
                {% else %}
                <img src="{% static 'images/no_image.png' %}" alt="no_image"
                    class="img-fluid rounded {% if not product.is_in_stock %}opacity-50{% endif %}">
                {% endif %}

                <!-- ğŸŸ¡ åœ¨åº«åˆ‡ã‚Œæ™‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‹é€šçŸ¥ãƒœã‚¿ãƒ³ -->
                {% if not product.is_in_stock %}
                <div class="alert alert-secondary small mt-3 text-center" role="alert">
                    ç¾åœ¨ã“ã®å•†å“ã¯åœ¨åº«åˆ‡ã‚Œã§ã™ã€‚<br>
                    å†å…¥è·æ™‚ã«é€šçŸ¥ã‚’å—ã‘å–ã‚ŠãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã§è¨­å®šã‚’åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã™ã€‚
                </div>

                <form method="post" class="text-center">
                    {% csrf_token %}
                    <button type="submit" name="toggle_restock_notify"
                        class="btn {% if product.restock_notify_enabled %}btn-outline-danger{% else %}btn-outline-success{% endif %} btn-sm rounded-pill px-4 mt-2">
                        {% if product.restock_notify_enabled %}é€šçŸ¥ã‚’åœæ­¢{% else %}é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–{% endif %}
                    </button>
                </form>
                {% endif %}

                <!-- å³ï¼šå•†å“æƒ…å ± -->
                <div class="col-md-7">
                    <h3 class="mb-3">
                        {{ product.product_name }}
                        {% if not product.is_in_stock %}
                        <span class="badge bg-secondary ms-2">åœ¨åº«ãªã—</span>
                        {% else %}
                        <span class="badge bg-success ms-2">åœ¨åº«ã‚ã‚Š</span>
                        {% endif %}
                    </h3>

                    <p class="text-muted mb-2">
                        ã‚«ãƒ†ã‚´ãƒªï¼š
                        {% if product.categories.exists %}
                        {{ product.categories.all|join:"ãƒ»" }}
                        {% else %}
                        æœªåˆ†é¡
                        {% endif %}
                    </p>

                    <p class="text-muted mb-2">ã‚·ãƒ§ãƒƒãƒ—åï¼š{{ product.shop_name|default:"ä¸æ˜" }}</p>
                    <hr>

                    <!-- ä¾¡æ ¼ãƒ»å„ªå…ˆåº¦è¡¨ç¤ºã¯å¾“æ¥é€šã‚Š -->

                    <a href="{{ product.product_url }}"
                        class="btn btn-outline-primary mt-3 {% if not product.is_in_stock %}disabled{% endif %}"
                        target="_blank" tabindex="{% if not product.is_in_stock %}-1{% else %}0{% endif %}">
                        å•†å“ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                    </a>
                </div>

                <!-- å³ï¼šå•†å“æƒ…å ± -->
                <div class="col-md-7">
                    <h3 class="mb-3">
                        {{ product.product_name }}
                        {% if not product.is_in_stock %}
                        <span class="badge bg-secondary ms-2">åœ¨åº«ãªã—</span>
                        {% else %}
                        <span class="badge bg-success ms-2">åœ¨åº«ã‚ã‚Š</span>
                        {% endif %}
                    </h3>

                    <p class="text-muted mb-2">ã‚«ãƒ†ã‚´ãƒªï¼š{{ product.category.category_name }}</p>
                    <p class="text-muted mb-2">ã‚·ãƒ§ãƒƒãƒ—åï¼š{{ product.shop_name|default:"ä¸æ˜" }}</p>
                    <hr>

                    <p class="mb-1"><strong>å®šä¾¡ï¼š</strong>
                        {% if product.regular_price %}
                        Â¥{{ product.regular_price|floatformat:0 }}
                        {% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
                    </p>

                    <p class="mb-1"><strong>ç™»éŒ²æ™‚ä¾¡æ ¼ï¼š</strong>
                        {% if product.initial_price %}
                        Â¥{{ product.initial_price|floatformat:0 }}
                        {% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
                    </p>

                    <p class="mb-1"><strong>è²·ã„æ™‚ä¾¡æ ¼ï¼š</strong>
                        {% if product.threshold_price %}
                        Â¥{{ product.threshold_price|floatformat:0 }}
                        {% else %}<span class="text-muted">æœªè¨­å®š</span>{% endif %}
                    </p>

                    <p class="mb-2">
                        <strong>å„ªå…ˆåº¦ï¼š</strong>
                        <span class="badge {% if product.priority == 'é«˜' %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ product.priority }}
                        </span>
                    </p>

                    <a href="{{ product.product_url }}"
                        class="btn btn-outline-primary mt-3 {% if not product.is_in_stock %}disabled{% endif %}"
                        target="_blank">
                        å•†å“ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                    </a>
                </div>
            </div>
        </div>

        <!-- è²·ã„æ™‚ä¾¡æ ¼è¨­å®š -->
        <div class="card shadow-sm p-4 mt-4">
            <h5 class="mb-3">è²·ã„æ™‚ä¾¡æ ¼ã®è¨­å®š</h5>

            {% if is_kaidoki %}
            <div id="kaidoki-banner" class="alert alert-success py-2 text-center fw-bold">
                è²·ã„æ™‚ï¼ ğŸ¯
            </div>
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-info text-center py-2 mt-2">
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}
            {% endif %}

            <form method="post" class="d-flex align-items-center justify-content-center gap-3">
                {% csrf_token %}
                {{ form.threshold_price }}
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </form>

            {% if form.threshold_price.errors %}
            <div class="text-danger small text-center mt-2">
                {{ form.threshold_price.errors.0 }}
            </div>
            {% endif %}
        </div>

        {{ price_data_json|json_script:"price-data-json" }}

        <!-- ã‚°ãƒ©ãƒ• -->
        <div class="card shadow-sm p-4 mt-4">
            <h5 class="mb-3">ä¾¡æ ¼ Ã— åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ•</h5>

            {% if has_history %}
            <div class="chart-wrap">
                <canvas id="priceChart" data-threshold="{{ product.threshold_price|default:0 }}"></canvas>
            </div>
            {% else %}
            <p class="text-center text-muted mb-0 py-4">ä¾¡æ ¼å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div>


        <!-- âœ… å¤–éƒ¨JSã‚’èª­ã¿è¾¼ã¿ -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script src="{% static 'js/product_detail.js' %}"></script>
        <script src="{% static 'js/product_banner.js' %}"></script>
        {% endblock %}
