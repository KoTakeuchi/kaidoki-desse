{% extends "layout-user.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% block body_class %}product-form-page{% endblock %}
{% block title %}{% if is_edit %}å•†å“ç·¨é›†{% else %}æ–°è¦å•†å“ç™»éŒ²{% endif %}{% endblock %}

{% block page_content %}
<!-- âœ… AUTHæº–æ‹ ã‚¿ã‚¤ãƒˆãƒ«æ§‹é€  -->
<div class="page-header">
  <h1 class="page-title">
    <span class="title-inner">
      {% if is_edit %}å•†å“ç·¨é›†{% else %}æ–°è¦å•†å“ç™»éŒ²{% endif %}
    </span>
  </h1>
</div>

<div class="container py-4">
  <form method="POST"
        action="{% if is_edit %}{% url 'main:product_edit' pk=product.id %}{% else %}{% url 'main:product_create' %}{% endif %}"
        novalidate>
    {% csrf_token %}

    <div class="card shadow-sm p-4">

      {% if not is_edit %}
      <!-- âœ… å•†å“URL -->
      <div class="mb-3" id="url-section">
        <label class="form-label section-title">å•†å“URL</label>
        <div class="position-relative">
          {{ form.product_url }}
          <!-- âœ… ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆURLç”¨ï¼‰ -->
          {% if form.product_url.errors %}
            <div id="url-error-message" class="url-error-box">
              {{ form.product_url.errors.0 }}
            </div>
          {% endif %}
        </div>

        <!-- âœ… å…¥åŠ›èª¬æ˜ -->
        <div class="form-text text-muted mt-1">
          æ¥½å¤©å¸‚å ´
          <a href="https://item.rakuten.co.jp/" target="_blank" class="text-decoration-underline text-primary">
            https://item.rakuten.co.jp/
          </a>
          ã®å•†å“URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <!-- âœ… API ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div id="api-status-message" class="mt-2 small text-center"></div>
      {% endif %}

      <!-- âœ… ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç·¨é›†æ™‚ã‚‚å¸¸ã«è¡¨ç¤ºï¼‰ -->
      <div class="text-center my-4">
        <img id="preview-image"
             src="{% if is_edit and product.image_url %}{{ product.image_url }}{% else %}{% static 'images/no_image.png' %}{% endif %}"
             alt="å•†å“ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
      </div>

      <!-- ğŸ”½ ç”»åƒURLï¼ˆJSã§è‡ªå‹•è¨­å®šï¼‰ -->
      <input type="hidden" name="image_url" id="image_url" value="{% if is_edit and product.image_url %}{{ product.image_url }}{% endif %}">

      <!-- âœ… å•†å“åãƒ»ã‚·ãƒ§ãƒƒãƒ—åãƒ»ç™»éŒ²æ™‚ä¾¡æ ¼ -->
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label class="form-label section-title">å•†å“å</label>
          {{ form.product_name }}
          {% if form.product_name.errors %}
            <div class="error-text">{{ form.product_name.errors.0 }}</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <label class="form-label section-title">ã‚·ãƒ§ãƒƒãƒ—å</label>
          {{ form.shop_name }}
          {% if form.shop_name.errors %}
            <div class="error-text">{{ form.shop_name.errors.0 }}</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <label class="form-label section-title">ç™»éŒ²æ™‚ä¾¡æ ¼</label>
          <div class="yen-group">
            {{ form.initial_price }}<span>å††</span>
          </div>
          {% if form.initial_price.errors %}
            <div class="error-text">{{ form.initial_price.errors.0 }}</div>
          {% endif %}
        </div>
      </div>

      <!-- âœ… ã‚«ãƒ†ã‚´ãƒªé¸æŠï¼ˆpillå‹ãƒ»æœ€ç››æœŸä»•æ§˜ï¼‰ -->
      <div class="mb-4">
        <div class="category-section">
          <div class="category-group">
            <label class="form-label section-title mb-0">
              ã‚«ãƒ†ã‚´ãƒª
              <span class="text-muted small">0ã€œ2å€‹é¸æŠã—ã¦ãã ã•ã„ã€‚</span>
            </label>
            <div class="category-tags mt-1">
              {% for cat in global_categories %}
                {% if cat.category_name != "æœªåˆ†é¡" %}
                  <span class="cat-tag common"
                        data-id="{{ cat.id }}"
                        data-type="common">
                    {{ cat.category_name }}
                  </span>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="category-group mt-3">
            <div class="category-tags">
              {% for cat in user_categories %}
                {% if cat.category_name != "æœªåˆ†é¡" %}
                  <span class="cat-tag user"
                        data-id="{{ cat.id }}"
                        data-type="user">
                    {{ cat.category_name }}
                  </span>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <input type="hidden" name="selected_cats" id="selected_cats" value="">
          <div id="category-limit-info" class="text-danger small mt-2"></div>
        </div>
      </div>

      <!-- âœ… å„ªå…ˆåº¦ -->
      <div class="mb-4">
        <div class="form-label section-title">å„ªå…ˆåº¦</div>
        <div class="d-flex align-items-center gap-3">
          <div class="form-switch d-flex align-items-center">
            <input class="form-check-input" type="checkbox" id="prioritySwitch"
                   {% if form.priority.value == "é«˜" %}checked{% endif %}>
            <label for="prioritySwitch" class="form-check-label fw-bold ms-2" id="priorityLabel">
              {% if form.priority.value == "é«˜" %}é«˜{% else %}æ™®é€š{% endif %}
            </label>
          </div>

          <div class="text-muted small" id="priorityDesc">
            {% if form.priority.value == "é«˜" %}
              6æ™‚é–“ã”ã¨ã«æœ€æ–°ä¾¡æ ¼ã‚’å–å¾—ã€‚é€šçŸ¥é »åº¦ãŒé«˜ã‚ã§ã™ã€‚
            {% else %}
              24æ™‚é–“ã”ã¨ã«æœ€æ–°ä¾¡æ ¼ã‚’å–å¾—ã€‚ã‚¢ãƒ—ãƒªé€šçŸ¥ãƒ»ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãªã—ã€‚
            {% endif %}
          </div>

          <!-- hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§é€ä¿¡å€¤ä¿æŒ -->
          <input type="hidden" name="priority" id="id_priority" value="{{ form.priority.value }}">
        </div>
        {% if form.priority.errors %}
          <div class="error-text mt-1">{{ form.priority.errors.0 }}</div>
        {% endif %}
      </div>

      <!-- âœ… é€šçŸ¥æ¡ä»¶ -->
      <div class="mb-4">
        <div class="d-flex align-items-center">
          <div class="form-label section-title mb-0">é€šçŸ¥æ¡ä»¶</div>
          {% if form.flag_type.errors %}
            <div class="text-danger small ms-3">{{ form.flag_type.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
        <div class="flag-buttons">
          <div class="flag-btn {% if form.flag_type.value == 'buy_price' %}active{% endif %}"
               data-type="buy_price"
               data-desc="æŒ‡å®šä¾¡æ ¼ä»¥ä¸‹ã«ãªã£ãŸã¨ãé€šçŸ¥ã—ã¾ã™ã€‚æœ€ã‚‚åŸºæœ¬çš„ãªé€šçŸ¥æ–¹æ³•ã§ã™ã€‚">
            è²·ã„æ™‚ä¾¡æ ¼
          </div>
          <div class="flag-btn {% if form.flag_type.value == 'percent_off' %}active{% endif %}"
               data-type="percent_off"
               data-desc="ç™»éŒ²æ™‚ä¾¡æ ¼ã‹ã‚‰æŒ‡å®šï¼…OFFã«ãªã£ãŸã¨ãé€šçŸ¥ã—ã¾ã™ã€‚ã‚»ãƒ¼ãƒ«ã‚„ã‚¤ãƒ™ãƒ³ãƒˆæ¤œçŸ¥ã«ä¾¿åˆ©ã§ã™ã€‚">
            å‰²å¼•ç‡
          </div>
          <div class="flag-btn {% if form.flag_type.value == 'lowest_price' %}active{% endif %}"
               data-type="lowest_price"
               data-desc="ç™»éŒ²ä»¥æ¥ã®æœ€å®‰å€¤ã‚’æ›´æ–°ã—ãŸã‚‰é€šçŸ¥ã—ã¾ã™ã€‚ä¾¡æ ¼å±¥æ­´ã«åŸºã¥ã„ãŸé€šçŸ¥ã§ã™ã€‚">
            æœ€å®‰å€¤
          </div>
        </div>

        <!-- âœ… èª¬æ˜ãƒœãƒƒã‚¯ã‚¹ -->
        <div class="flag-desc-box" id="flagDesc">
          ãƒœã‚¿ãƒ³ã«ãƒã‚¦ã‚¹ã‚’ä¹—ã›ã‚‹ã¨èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </div>

        <!-- å…¥åŠ›æ¬„ -->
        <div class="row g-3 mt-0">
          <!-- è²·ã„æ™‚ä¾¡æ ¼ -->
          <div class="col-md-3 position-relative" id="wrap_threshold"
               {% if form.flag_type.value == 'buy_price' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <label class="form-label section-title">è²·ã„æ™‚ä¾¡æ ¼</label>
            <div class="price-input-wrap position-relative d-inline-block">
              <div class="yen-group">
                {{ form.threshold_price }}
                <span>å††</span>
              </div>
              {% if form.threshold_price.errors %}
                <span class="text-danger small position-absolute"
                      style="top:50%; transform:translateY(-50%); left:calc(100% + 10px); white-space:nowrap;">
                  {{ form.threshold_price.errors.0 }}
                </span>
              {% endif %}
            </div>
          </div>

          <!-- å‰²å¼•ç‡ -->
          <div class="col-md-3" id="wrap_percent"
               {% if form.flag_type.value == 'percent_off' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <label class="form-label section-title">å‰²å¼•ç‡</label>
            <div class="yen-group">
              <select name="flag_value" id="id_flag_value" class="form-select">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="30">30</option>
                <option value="50">50</option>
              </select>
              <span>ï¼…</span>
            </div>
          </div>
        </div>

        <input type="hidden" name="flag_type" id="flagTypeHidden" value="{{ form.flag_type.value }}">
      </div>

    </div> <!-- .card shadow-sm p-4 -->

    <!-- âœ… æˆ»ã‚‹ï¼ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰å¤–ï¼‰ -->
    <div class="form-footer d-flex justify-content-between align-items-center mt-4">
      <a href="{% url 'main:product_list' %}" class="btn btn-outline-secondary rounded-pill px-4">
        â† ä¸€è¦§ã¸æˆ»ã‚‹
      </a>
      <button type="submit" class="btn btn-danger rounded-pill px-5" style="background:#C35656;border:none;">
        {% if is_edit %}æ›´æ–°ã™ã‚‹{% else %}ç™»éŒ²ã™ã‚‹{% endif %}
      </button>
    </div>

  </form>
</div>

<script>
  const FETCH_RAKUTEN_URL = "{% url 'main:fetch_rakuten_item' %}";
</script>
<script src="{% static 'js/product_form.js' %}"></script>
<script src="{% static 'js/flag_setting.js' %}"></script>
<script src="{% static 'js/category_limit.js' %}"></script>
{% endblock %}
