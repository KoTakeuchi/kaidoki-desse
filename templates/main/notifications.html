{% extends "layout-user.html" %}
{% load static %}
{% load humanize %}
{% block title %}é€šçŸ¥ä¸€è¦§{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/notification_list.js' %}" defer></script>
{% endblock %}

{% block page_content %}
<div class="page-header">
  <h1 class="page-title">
    <span class="title-inner">é€šçŸ¥ä¸€è¦§</span>
  </h1>
</div>

<div class="container py-4">

  {# âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨å…¨ã¦æ—¢èª­ãƒœã‚¿ãƒ³ #}
  <div class="notification-filter-bar">
    <div class="notification-filter-left">
      <select id="notificationFilter" class="form-select notification-filter-select">
        <option value="all" selected>æœªèª­é€šçŸ¥ ({{ logs|length }})</option>
        <option value="buy_time">è²·ã„æ™‚é€šçŸ¥</option>
        <option value="stock">åœ¨åº«é€šçŸ¥</option>
      </select>
    </div>

    {% if logs %}
    <button id="markAllReadBtn" class="btn btn-outline-secondary notification-mark-all-btn">
      ã™ã¹ã¦æ—¢èª­ã«ã™ã‚‹
    </button>
    {% endif %}
  </div>

  {# âœ… ã‚«ãƒ¼ãƒ‰ #}
  <div class="card shadow-sm p-0">
    {% if logs %}
    <ul class="list-group list-group-flush" id="notificationList">
      {% for n in logs %}
      <li class="list-group-item notification-item"
        data-type="{% if n.event_type == 'stock_restore' or n.event_type == 'stock_few' %}stock{% else %}buy_time{% endif %}"
        data-id="{{ n.id }}">

        <a href="{% url 'main:notification_redirect' n.id %}" class="notification-link">

          <div class="notification-content">

            {# âœ… é€šçŸ¥ã‚¿ã‚°ï¼ˆç”»åƒã®å·¦ï¼‰ #}
            <span class="notification-tag">
              {% if n.event_type == "stock_restore" %}
              <span class="badge bg-success">åœ¨åº«å¾©æ´»</span>
              {% elif n.event_type == "stock_few" %}
              <span class="badge bg-warning text-dark">åœ¨åº«å°‘</span>
              {% elif n.event_type == "threshold_hit" %}
              <span class="badge notification-badge-buytime">è²·ã„æ™‚</span>
              {% elif n.event_type == "lowest_price" %}
              <span class="badge bg-info">æœ€å®‰å€¤</span>
              {% elif n.event_type == "discount_over" %}
              <span class="badge bg-secondary">å‰²å¼•ç‡</span>
              {% endif %}
            </span>

            {# âœ… å•†å“ç”»åƒã‚µãƒ ãƒã‚¤ãƒ« #}
            {% if n.product.image_url %}
            <img src="{{ n.product.image_url }}" alt="{{ n.product.product_name }}" class="notification-thumbnail">
            {% else %}
            <div class="notification-thumbnail-placeholder">
              <span>ğŸ“¦</span>
            </div>
            {% endif %}

            {# âœ… å•†å“åã¨è©³ç´°æƒ…å ± #}
            <div class="notification-info">
              {# å•†å“å #}
              <div class="notification-product-name-wrap">
                <h6 class="notification-product-name" title="{{ n.product.product_name }}">
                  {% if n.product.product_name|length > 50 %}
                    {{ n.product.product_name|slice:":50" }}...
                  {% else %}
                    {{ n.product.product_name }}
                  {% endif %}
                </h6>
              </div>

              {# ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹ #}
              <div class="notification-event-wrap">
                <p class="notification-event-name">
                  {% if n.event_type == "stock_restore" %}
                  åœ¨åº«ãŒå¾©æ´»ã—ã¾ã—ãŸ
                  {% elif n.event_type == "stock_few" %}
                  åœ¨åº«ãŒã‚ãšã‹ã«ãªã‚Šã¾ã—ãŸ
                  {% elif n.event_type == "threshold_hit" %}
                  è²·ã„æ™‚ä¾¡æ ¼ã«åˆ°é”ã—ã¾ã—ãŸ
                  {% elif n.event_type == "lowest_price" %}
                  æœ€å®‰å€¤ã‚’æ›´æ–°ã—ã¾ã—ãŸ
                  {% elif n.event_type == "discount_over" %}
                  æŒ‡å®šå‰²å¼•ç‡ã‚’ä¸‹å›ã‚Šã¾ã—ãŸ
                  {% else %}
                  {{ n.message|default:"é€šçŸ¥" }}
                  {% endif %}
                </p>
              </div>

              {# è©³ç´°æƒ…å ±ï¼ˆä¾¡æ ¼ãƒ»åœ¨åº«ï¼‰ #}
              <div class="notification-details">
                {% if n.event_type == "stock_restore" or n.event_type == "stock_few" %}
                  <span class="detail-item">
                    <strong>åœ¨åº«:</strong> {{ n.product.latest_stock|default:"ä¸æ˜" }}å€‹
                  </span>
                  <span class="detail-separator">|</span>
                  <span class="detail-item">
                    <strong>æœ€æ–°ä¾¡æ ¼:</strong> Â¥{{ n.product.latest_price|default:0|floatformat:0|intcomma }}
                  </span>

                {% elif n.event_type == "threshold_hit" %}
                  <span class="detail-item">
                    <strong>æœ€æ–°ä¾¡æ ¼:</strong> Â¥{{ n.product.latest_price|default:0|floatformat:0|intcomma }}
                  </span>
                  <span class="detail-separator">|</span>
                  <span class="detail-item">
                    <strong>è²·ã„æ™‚ä¾¡æ ¼:</strong> Â¥{{ n.product.threshold_price|default:0|floatformat:0|intcomma }}
                  </span>

                {% elif n.event_type == "lowest_price" %}
                  <span class="detail-item">
                    <strong>æœ€å®‰å€¤:</strong> Â¥{{ n.product.latest_price|default:0|floatformat:0|intcomma }}
                  </span>

                {% elif n.event_type == "discount_over" %}
                  <span class="detail-item">
                    <strong>æœ€æ–°ä¾¡æ ¼:</strong> Â¥{{ n.product.latest_price|default:0|floatformat:0|intcomma }}
                  </span>
                  {% if n.product.latest_discount %}
                  <span class="detail-separator">|</span>
                  <span class="detail-item detail-discount">
                    <strong>å‰²å¼•ç‡:</strong> {{ n.product.latest_discount|floatformat:0 }}% OFF
                  </span>
                  {% endif %}

                {% else %}
                  <span class="detail-item">
                    <strong>æœ€æ–°ä¾¡æ ¼:</strong> Â¥{{ n.product.latest_price|default:0|floatformat:0|intcomma }}
                  </span>
                  <span class="detail-separator">|</span>
                  <span class="detail-item">
                    <strong>åœ¨åº«:</strong> {{ n.product.latest_stock|default:"ä¸æ˜" }}å€‹
                  </span>
                {% endif %}
              </div>
            </div>

            {# âœ… æ—¥ä»˜ï¼ˆå³å´ï¼‰ #}
            <div class="notification-date">
              <small class="text-muted">{{ n.occurred_at|date:"n/j H:i" }}</small>
            </div>
          </div>
        </a>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <div class="notification-empty">
      <p>é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    </div>
    {% endif %}
  </div>

  {# âœ… ä¸€è¦§ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ #}
  <div class="notification-back-btn-wrap">
    <a href="{% url 'main:product_list' %}" class="btn btn-outline-secondary notification-back-btn">
      â† ä¸€è¦§ã¸æˆ»ã‚‹
    </a>
  </div>
</div>
{% endblock %}
