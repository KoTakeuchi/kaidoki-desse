{% extends "admin_app/layout-admin.html" %}
{% load static %}

{% block title %}Kaidoki Desse ç®¡ç† | å•†å“ç®¡ç†{% endblock %}

{% block admin_content %}
<div class="container-fluid py-4">
  <h2 class="fw-bold mb-4 text-dark mt-3">å•†å“ç®¡ç†</h2>

  <!-- ğŸ” æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form method="get" class="d-flex align-items-end flex-wrap gap-3 mb-4">

    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ -->
    <div class="flex-fill" style="min-width:240px;">
      <label class="form-label fw-semibold text-secondary">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="å•†å“åãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ã‚«ãƒ†ã‚´ãƒª">
    </div>

    <!-- çŠ¶æ…‹ -->
    <div>
      <label class="form-label fw-semibold text-secondary">çŠ¶æ…‹</label>
      <select name="is_deleted" class="form-select">
        <option value="">å…¨ã¦</option>
        <option value="false" {% if request.GET.is_deleted == "false" %}selected{% endif %}>å­˜ç¶š</option>
        <option value="true" {% if request.GET.is_deleted == "true" %}selected{% endif %}>å‰Šé™¤æ¸ˆ</option>
      </select>
    </div>

    <!-- é€šçŸ¥æ¡ä»¶ -->
    <div>
      <label class="form-label fw-semibold text-secondary">é€šçŸ¥æ¡ä»¶</label>
      <select name="flag_type" class="form-select">
        <option value="">å…¨ã¦</option>
        <option value="buy_price" {% if request.GET.flag_type == "buy_price" %}selected{% endif %}>è²·ã„æ™‚ä¾¡æ ¼</option>
        <option value="percent_off" {% if request.GET.flag_type == "percent_off" %}selected{% endif %}>å‰²å¼•ç‡</option>
        <option value="lowest_price" {% if request.GET.flag_type == "lowest_price" %}selected{% endif %}>æœ€å®‰å€¤</option>
      </select>
    </div>

    <!-- å„ªå…ˆåº¦ -->
    <div>
      <label class="form-label fw-semibold text-secondary">å„ªå…ˆåº¦</label>
      <select name="priority" class="form-select">
        <option value="">å…¨ã¦</option>
        <option value="é«˜" {% if request.GET.priority == "é«˜" %}selected{% endif %}>é«˜</option>
        <option value="æ™®é€š" {% if request.GET.priority == "æ™®é€š" %}selected{% endif %}>æ™®é€š</option>
      </select>
    </div>

    <!-- é–‹å§‹æ—¥ -->
    <div>
      <label class="form-label fw-semibold text-secondary">é–‹å§‹æ—¥ï¼ˆç™»éŒ²æ—¥ï¼‰</label>
      <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control">
    </div>

    <!-- çµ‚äº†æ—¥ -->
    <div>
      <label class="form-label fw-semibold text-secondary">çµ‚äº†æ—¥</label>
      <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control">
    </div>

    <!-- æ¤œç´¢ãƒ»ã‚¯ãƒªã‚¢ -->
    <div class="d-flex gap-2 align-items-end">
      <button type="submit" class="btn text-white px-4" style="background-color:#3CA9A9;">æ¤œç´¢</button>
      <a href="{% url 'admin_app:admin_product_list' %}" class="btn btn-outline-secondary px-4">ã‚¯ãƒªã‚¢</a>
    </div>
  </form>
  <!-- ========================== -->
  <!-- ğŸ“„ è¡¨ç¤ºä»¶æ•°åˆ‡æ›¿ãƒ•ã‚©ãƒ¼ãƒ  -->
  <!-- ========================== -->
  <div class="text-end mb-2">
    <form method="get" class="d-inline">
      <input type="hidden" name="q" value="{{ query }}">
      <select name="per_page" onchange="this.form.submit()" class="form-select form-select-sm w-auto d-inline">
        <option value="20" {% if request.GET.per_page == '20' or not request.GET.per_page %}selected{% endif %}>20ä»¶</option>
        <option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50ä»¶</option>
        <option value="100" {% if request.GET.per_page == '100' %}selected{% endif %}>100ä»¶</option>
      </select>
    </form>
  </div>


  <!-- ğŸ“‹ å•†å“ä¸€è¦§ -->
  {% if products %}
  <div class="table-responsive">
    <table class="table table-hover align-middle border-top" style="border-color:#b4e4e4;">
      <thead>
          <tr class="text-secondary">
            <th style="width:4%;">ID</th>
            <th style="width:9%;">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
            <th style="width:5%;">çŠ¶æ…‹</th>
            <th style="width:7%;">é€šçŸ¥æ¡ä»¶</th>
            <th style="width:5%;">å„ªå…ˆåº¦</th>
            <th style="width:18%;">ã‚«ãƒ†ã‚´ãƒªå</th>
            <th style="width:32%;">å•†å“å</th>
            <th style="width:10%;">ç™»éŒ²æ—¥</th>
            <th style="width:5%;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for p in products %}
          <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.user.username }}</td>
            <td>
              {% if p.is_deleted %}
                å‰Šé™¤æ¸ˆ
              {% else %}
                å­˜ç¶š
              {% endif %}
            </td>
            <!-- âœ… é€šçŸ¥æ¡ä»¶ï¼ˆã‚¿ã‚°ã®ã¿ã€‚æ•°å€¤å‰Šé™¤ï¼‰ -->
            <td>
              {% if p.flag_type %}
                {% if p.flag_type == "buy_price" %}
                  è²·ã„æ™‚ä¾¡æ ¼
                {% elif p.flag_type == "percent_off" %}
                  å‰²å¼•ç‡
                {% elif p.flag_type == "lowest_price" %}
                  æœ€å®‰å€¤
                {% endif %}
              {% else %}
                -
              {% endif %}
            </td>
            <!-- âœ… å„ªå…ˆåº¦ã‚¿ã‚°ï¼ˆç™½é»’åè»¢ï¼‰ -->
            <td>
              {% if p.priority == "é«˜" %}
                é«˜
              {% else %}
                æ™®é€š
              {% endif %}
            </td>

            <!-- âœ… ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ [testuser] [å…±é€š] ã‚’é™¤å¤– -->
            <td>
              {% if p.categories.all %}
                {% with p.categories.all|join:" / " as category_list %}
                  {{ category_list|cut:"[testuser]"|cut:"[å…±é€š]" }}
                {% endwith %}
              {% else %}
                -
              {% endif %}
            </td>

            <td class="text-truncate" style="max-width:220px;">{{ p.product_name }}</td>
            <td>{{ p.created_at|date:"Y/m/d H:i" }}</td>

            <!-- âœ… è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å‘¼ã³å‡ºã— -->
            <td>
              <button class="btn btn-sm text-white rounded-0"
                      style="background-color:#3CA9A9;"
                      data-bs-toggle="modal"
                      data-bs-target="#productDetailModal{{ p.id }}">
                è©³ç´°
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
  </div>

  <!-- â–¼ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  {% for p in products %}
  <div class="modal fade" id="productDetailModal{{ p.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 rounded-0">
        <div class="modal-header" style="background-color:#b4e4e4;">
          <h5 class="modal-title fw-bold text-dark">å•†å“è©³ç´°</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
        </div>
        <div class="modal-body">
          <table class="table table-borderless mb-0">
            <tr><th class="text-secondary" style="width:25%;">å•†å“å</th><td>{{ p.product_name }}</td></tr>
            <tr><th class="text-secondary">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><td>{{ p.user.username }}</td></tr>
              <td>
                <tr>
                  <th class="text-secondary">ã‚«ãƒ†ã‚´ãƒª</th>
                  <td>
                    {% if p.categories.exists %}
                      {% for c in p.categories.all %}
                        {{ c.category_name|cut:"[testuser]"|cut:"[å…±é€š]" }}{% if not forloop.last %} / {% endif %}
                      {% endfor %}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
              </td>
            </tr>
            <tr><th class="text-secondary">é€šçŸ¥æ¡ä»¶</th>
              <td>
                {% if p.flag_type == "buy_price" %}
                  <span class="badge text-white rounded-0 px-2 py-1" style="background-color:#9c566d;">è²·ã„æ™‚ä¾¡æ ¼</span>
                {% elif p.flag_type == "percent_off" %}
                  <span class="badge text-white rounded-0 px-2 py-1" style="background-color:#9c8e56;">å‰²å¼•ç‡</span>
                {% elif p.flag_type == "lowest_price" %}
                  <span class="badge text-white rounded-0 px-2 py-1" style="background-color:#56669c;">æœ€å®‰å€¤</span>
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
            <tr><th class="text-secondary">å„ªå…ˆåº¦</th>
              <td>
                {% if p.priority == "é«˜" %}
                  <span class="badge bg-dark text-white rounded-0 px-2 py-1">é«˜</span>
                {% else %}
                  <span class="badge bg-white text-dark border border-dark rounded-0 px-2 py-1">æ™®é€š</span>
                {% endif %}
              </td>
            </tr>
            <tr><th class="text-secondary">ç™»éŒ²æ—¥</th><td>{{ p.created_at|date:"Y/m/d H:i" }}</td></tr>
            <tr><th class="text-secondary">å•†å“URL</th>
              <td>
                {% if p.product_url %}
                  <a href="{{ p.product_url }}" target="_blank" class="text-decoration-underline text-dark">{{ p.product_url }}</a>
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
        <div class="modal-footer bg-light justify-content-center">
          <button type="button" class="btn btn-outline-dark rounded-0" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  {% include "components/pagination.html" with page_obj=page_obj paginator=paginator %}
  {% else %}
  <p class="text-muted mt-3">å•†å“ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>
{% endblock %}
