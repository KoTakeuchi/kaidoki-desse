{% extends "admin_app/layout-admin.html" %}
{% load static %}

{% block page_title %}Kaidoki Desse ç®¡ç† | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin.css' %}">
<style>
  .metric-card {
    background-color: #f8f9fa;
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 0.5rem;
  }
  .metric-sub {
    font-size: 0.85rem;
    color: #888;
  }
  .metric-diff {
    font-size: 0.85rem;
    color: #C35656;
  }
  .table td, .table th {
    vertical-align: middle;
  }
</style>
{% endblock %}

{% block admin_content %}
<div class="container-fluid px-0">
  <h2 class="mb-4 fw-bold text-dark">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>

  <!-- ======================== -->
  <!-- ä¸ŠåŠåˆ†ï¼šãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
  <!-- ======================== -->
  <div class="row g-3 mb-5">
    <div class="col-md-2">
      <div class="card metric-card text-center py-3">
        <h6 class="text-muted mb-1">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h6>
        <h3 class="fw-bold text-dark mb-1">{{ stats.user_count }}</h3>
        <div class="metric-sub">ä»Šæœˆ: {{ stats.user_month }} <span class="metric-diff">{{ stats.user_diff }}</span></div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card metric-card text-center py-3">
        <h6 class="text-muted mb-1">ç™»éŒ²å•†å“æ•°</h6>
        <h3 class="fw-bold text-dark mb-1">{{ stats.product_count }}</h3>
        <div class="metric-sub">ä»Šæœˆ: {{ stats.product_month }} <span class="metric-diff">{{ stats.product_diff }}</span></div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card metric-card text-center py-3">
        <h6 class="text-muted mb-1">é€šçŸ¥æ•°</h6>
        <h3 class="fw-bold text-dark mb-1">{{ stats.notification_week }}</h3>
        <div class="metric-sub">ä»Šæœˆ: {{ stats.notification_month }} <span class="metric-diff">{{ stats.notification_diff }}</span></div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card metric-card text-center py-3">
        <h6 class="text-muted mb-1">ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°</h6>
        <h3 class="fw-bold text-dark mb-1">{{ stats.error_count }}</h3>
        <div class="metric-sub">ä»Šæœˆ: {{ stats.error_month }} <span class="metric-diff">{{ stats.error_diff }}</span></div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card metric-card text-center py-3">
        <h6 class="text-muted mb-1">é€šçŸ¥æˆåŠŸç‡</h6>
        <h3 class="fw-bold text-dark mb-1">{{ stats.notification_success }}%</h3>
        <div class="metric-sub">å‰æœˆæ¯” <span class="metric-diff">{{ stats.success_diff }}</span></div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card metric-card text-center py-3">
        <h6 class="text-muted mb-1">æœªå¯¾å¿œã‚¨ãƒ©ãƒ¼ç‡</h6>
        <h3 class="fw-bold text-dark mb-1">{{ stats.unresolved_rate }}%</h3>
        <div class="metric-sub">å‰æœˆæ¯” <span class="metric-diff">{{ stats.unresolved_diff }}</span></div>
      </div>
    </div>
  </div>

    <!-- ======================== -->
  <!-- ä¸‹åŠåˆ†ï¼šé€šçŸ¥ & ã‚¨ãƒ©ãƒ¼ -->
  <!-- ======================== -->
  <div class="row">
    <!-- ğŸ”” æœ€æ–°ã®é€šçŸ¥ -->
    <div class="col-md-6">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h5 class="fw-bold mb-0 text-dark">æœ€æ–°ã®é€šçŸ¥</h5>
        </div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr class="text-secondary">
                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                <th>é€šçŸ¥æ–¹æ³•</th>
                <th>å†…å®¹</th>
                <th>é€šçŸ¥æ—¥æ™‚</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for n in latest_notifications %}
              <tr>
                <td>{{ n.user.username|default:"-" }}</td>
                <td>
                  {% if "mail_" in n.event_type %}
                    ãƒ¡ãƒ¼ãƒ«
                  {% else %}
                    ã‚¢ãƒ—ãƒª
                  {% endif %}
                </td>
                <td>
                  {% if n.event_type == "threshold_hit" %}è²·ã„æ™‚ä¾¡æ ¼æ¤œçŸ¥
                  {% elif n.event_type == "lowest_price" %}æœ€å®‰å€¤æ›´æ–°
                  {% elif n.event_type == "discount_over" %}å‰²å¼•ç‡æ¤œçŸ¥
                  {% elif n.event_type == "stock_restore" %}åœ¨åº«å¾©æ´»
                  {% elif n.event_type == "stock_few" %}åœ¨åº«å°‘
                  {% else %}-{% endif %}
                </td>
                <td>{{ n.occurred_at|date:"Y/m/d H:i" }}</td>
                <td><a href="{% url 'admin_app:admin_notification_detail' n.id %}" class="btn btn-outline-dark btn-sm">è©³ç´°</a></td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted py-3">é€šçŸ¥ãªã—</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- âš ï¸ æœ€æ–°ã®ã‚¨ãƒ©ãƒ¼ -->
    <div class="col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h5 class="fw-bold mb-0 text-dark">æœ€æ–°ã®ã‚¨ãƒ©ãƒ¼</h5>
        </div>
        <div class="card-body p-0">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr class="text-secondary">
                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                <th>ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥</th>
                <th>ç™ºç”Ÿç®‡æ‰€</th>
                <th>ç™ºç”Ÿæ—¥æ™‚</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for e in latest_errors %}
              <tr>
                <td>{{ e.user.username|default:"-" }}</td>
                <td>{{ e.type_name|default:"-" }}</td>
                <td>{{ e.source|default:"-" }}</td>
                <td>{{ e.occurred_at|default:e.created_at|date:"Y/m/d H:i" }}</td>
                <td><a href="{% url 'admin_app:admin_error_detail' e.id %}" class="btn btn-outline-dark btn-sm">è©³ç´°</a></td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted py-3">ã‚¨ãƒ©ãƒ¼ãªã—</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆç”»åƒ -->
  <!-- ======================== -->
  <div class="chart-image-container mt-4">
    <img src="{% static 'images/charts.png' %}" alt="çµ±è¨ˆãƒãƒ£ãƒ¼ãƒˆ" class="img-fluid dashboard-chart">
  </div>
</div>
{% endblock %}
