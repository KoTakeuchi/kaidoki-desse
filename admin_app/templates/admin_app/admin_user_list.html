{% extends "admin_app/layout-admin.html" %}
{% load static %}

{% block title %}Kaidoki Desse ç®¡ç† | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§{% endblock %}

{% block admin_content %}
<div class="container-fluid py-4">
  <h2 class="fw-bold mb-4 text-dark">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>

  <form method="get" class="d-flex align-items-end flex-wrap gap-2 mb-4 justify-content-between" style="width:100%;">
    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ -->
    <div style="width:20%;">
      <label class="form-label fw-semibold text-secondary">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ¡ãƒ¼ãƒ«">
    </div>

    <!-- æ¨©é™ -->
    <div style="width:11%;">
      <label class="form-label fw-semibold text-secondary">æ¨©é™</label>
      <select name="role" class="form-select">
        <option value="">å…¨ã¦</option>
        <option value="staff" {% if request.GET.role == "staff" %}selected{% endif %}>ç®¡ç†è€…</option>
        <option value="user" {% if request.GET.role == "user" %}selected{% endif %}>ä¸€èˆ¬</option>
      </select>
    </div>

    <!-- çŠ¶æ…‹ -->
    <div style="width:11%;">
      <label class="form-label fw-semibold text-secondary">çŠ¶æ…‹</label>
      <select name="is_active" class="form-select">
        <option value="">å…¨ã¦</option>
        <option value="true" {% if request.GET.is_active == "true" %}selected{% endif %}>æœ‰åŠ¹</option>
        <option value="false" {% if request.GET.is_active == "false" %}selected{% endif %}>ç„¡åŠ¹</option>
      </select>
    </div>

    <!-- æ—¥ä»˜åŸºæº– -->
    <div style="width:11%;">
      <label class="form-label fw-semibold text-secondary">æ—¥ä»˜åŸºæº–</label>
      <select name="date_field" class="form-select">
        <option value="date_joined" {% if request.GET.date_field == "date_joined" %}selected{% endif %}>ç™»éŒ²æ—¥</option>
        <option value="last_login" {% if request.GET.date_field == "last_login" %}selected{% endif %}>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</option>
      </select>
    </div>

    <!-- é–‹å§‹æ—¥ -->
    <div style="width:11%;">
      <label class="form-label fw-semibold text-secondary">é–‹å§‹æ—¥</label>
      <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control">
    </div>

    <!-- çµ‚äº†æ—¥ -->
    <div style="width:11%;">
      <label class="form-label fw-semibold text-secondary">çµ‚äº†æ—¥</label>
      <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control">
    </div>

    <!-- æ¤œç´¢ï¼ã‚¯ãƒªã‚¢ -->
    <div style="width:17%;" class="d-flex gap-2 align-items-end justify-content-end">
      <button type="submit" class="btn text-white px-3" style="background-color:#3CA9A9;">æ¤œç´¢</button>
      <a href="{% url 'admin_app:admin_user_list' %}" class="btn btn-outline-secondary px-3">ã‚¯ãƒªã‚¢</a>
    </div>
  </form>

  <!-- â–¼ è¡¨ç¤ºä»¶æ•°åˆ‡æ›¿ -->
  <div class="text-end mb-2">
    <form method="get" class="d-inline">
      <input type="hidden" name="q" value="{{ query }}">
      <select name="per_page" onchange="this.form.submit()" class="form-select form-select-sm w-auto d-inline">
        <option value="20" {% if request.GET.per_page == '20' or not request.GET.per_page %}selected{% endif %}>20ä»¶
        </option>
        <option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50ä»¶</option>
        <option value="100" {% if request.GET.per_page == '100' %}selected{% endif %}>100ä»¶</option>
      </select>
    </form>
  </div>


  <!-- ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
  {% if users %}
  <div class="table-responsive">
    <table class="table table-hover align-middle border-top" style="border-color:#b4e4e4;">
      <thead>
        <tr>
          <th style="width:4%;">ID</th>
          <th style="width:6%;">æ¨©é™</th>
          <th style="width:6%;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th style="width:12%;">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
          <th style="width:12%;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <th style="width:4%;">å•†å“æ•°</th>
          <th style="width:6%;">ãƒ­ã‚°ã‚¤ãƒ³å›æ•°</th>
          <th style="width:10%;">ç™»éŒ²æ—¥æ™‚</th>
          <th style="width:10%;">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
          <th style="width:5%;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>{{ u.id }}</td>
          <td>
            {% if u.is_staff %}
            ç®¡ç†è€…
            {% else %}
            ä¸€èˆ¬
            {% endif %}
          </td>
          <!-- çŠ¶æ…‹ -->
          <td>
            {% if u.is_active %}
            æœ‰åŠ¹
            {% else %}
            ç„¡åŠ¹
            {% endif %}
          </td>
          <td>{{ u.username }}</td>
          <td>{{ u.email|default:"-" }}</td>
          <td>{{ u.products.count }}</td>
          <!-- ãƒ­ã‚°ã‚¤ãƒ³å›æ•° -->
          <td>{{ u.profile.login_count|default:0 }}</td>
          <td>{{ u.date_joined|date:"Y/m/d H:i" }}</td>
          <td>{{ u.last_login|date:"Y/m/d H:i" }}</td>
          <td>
            <button class="btn btn-sm text-white rounded-0" style="background-color:#3CA9A9;" data-bs-toggle="modal"
              data-bs-target="#userDetailModal{{ u.id }}">
              è©³ç´°
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>

  <!-- â–¼ ãƒ«ãƒ¼ãƒ—å¤–ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã¾ã¨ã‚ã¦é…ç½® -->
  {% for u in users %}
  <div class="modal fade custom-slide" id="userDetailModal{{ u.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 rounded-0">
        <div class="modal-header" style="background-color:#b4e4e4;">
          <h5 class="modal-title fw-bold text-dark">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
        </div>
        <div class="modal-body">
          <table class="table table-borderless mb-0">
            <tr>
              <th style="width: 25%;" class="text-secondary">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
              <td>{{ u.username }}</td>
            </tr>
            <tr>
              <th class="text-secondary">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
              <td>{{ u.email|default:"-" }}</td>
            </tr>
            <tr>
              <th class="text-secondary">ç™»éŒ²æ—¥</th>
              <td>{{ u.date_joined|date:"Y/m/d H:i" }}</td>
            </tr>
            <tr>
              <th class="text-secondary">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
              <td>{{ u.last_login|date:"Y/m/d H:i"|default:"-" }}</td>
            </tr>
            <tr>
              <th class="text-secondary">æ¨©é™</th>
              <td>{% if u.is_superuser %}ç®¡ç†è€…{% elif u.is_staff %}ã‚¹ã‚¿ãƒƒãƒ•{% else %}ä¸€èˆ¬{% endif %}</td>
            </tr>
            <tr>
              <th class="text-secondary">ç™»éŒ²å•†å“æ•°</th>
              <td>{{ u.product_count }}</td>
            </tr>
          </table>
        </div>
        <div class="modal-footer bg-light justify-content-center">
          <button type="button" class="btn btn-outline-dark rounded-0" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  {% include "components/pagination.html" with page_obj=page_obj paginator=paginator %}

  {% else %}
  <p class="text-muted mt-3">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>
{% endblock %}
